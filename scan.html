<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Validar ticket QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- html5-qrcode CSS -->
  <link rel="stylesheet" href="https://unpkg.com/html5-qrcode@latest/html5-qrcode.min.css" />
  <style>
    body { font-family: 'Roboto', sans-serif; margin:0; padding:0; background:#f3f5fa; color:#222; }
    #container { max-width:400px; margin:auto; padding:20px; background:#fff; border-radius:15px; box-shadow:0 2px 8px #aaa;}
    .nombre { font-size:1.2em; font-weight:bold; margin:16px 0;}
    .error { color:tomato; font-size:1.1em;}
    #scan-again { display:none; margin-top:20px; padding:8px 24px; background:#0a67fa; color:white; border-radius:8px; border:none;}
    @media(max-width:500px){
      #container{max-width:100%; padding:8px;}
    }
  </style>
</head>
<body>
  <div id="container">
    <h2>Escanea tu Ticket QR</h2>
    <div id="qr-reader" style="width:100%"></div>
    <div id="result"></div>
    <button id="scan-again">Escanear otro</button>
  </div>
  <script src="https://unpkg.com/html5-qrcode@latest/html5-qrcode.min.js"></script>
  <script>
    const apiUrl = "https://script.google.com/macros/s/AKfycbwIllP5yBJ3DWnQrY-4LOfED6_6m2tdMNXmJwIEwJj3xgZfPDNLPRqFEAJRUm79SCbplA/exec"; // AquÃ­ va tu URL del Web App
    
    const resultDiv = document.getElementById('result');
    const scanAgainBtn = document.getElementById('scan-again');
    
    function startScanner() {
      resultDiv.innerHTML = '';
      scanAgainBtn.style.display = 'none';
      const html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          html5QrCode.stop();
          buscarTicket(qrCodeMessage);
        },
        errorMsg => {} // puedes mostrar errores si quieres
      );
      scanAgainBtn.onclick = () => {
        html5QrCode.clear();
        startScanner();
      };
    }
    
    async function buscarTicket(code) {
      resultDiv.innerHTML = "Buscando ticket...";
      try {
        const res = await fetch(apiUrl + '?code=' + encodeURIComponent(code));
        const data = await res.json();
        if (data.success) {
          resultDiv.innerHTML = `
            <div class='nombre'>Nombre asociado: ${data.nombre}</div>
          `;
          scanAgainBtn.style.display = 'block';
        } else {
          resultDiv.innerHTML = `<div class='error'>${data.message}</div>`;
          scanAgainBtn.style.display = 'block';
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class='error'>Error al consultar ticket</div>`;
        scanAgainBtn.style.display = 'block';
      }
    }
    
    startScanner();
  </script>
</body>
</html>
